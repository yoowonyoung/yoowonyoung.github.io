---
layout: post
title: "Real MySQL 06 : 데이터 압축"
description: Real MySQL 6장 - 데이터 압축
date: 2021-11-14 16:23:00 +09:00
categories: MySQL RealMySQL Study
---

# 데이터 압축

## 페이지 압축
- Transparent Page Compression, MySQL 서버가 디스크에 저장하는 시점에 데이터가 압축되어 저장 & MySQL서버가 디스크에서 데이터 페이지를 읽어올때 압축이 해제되기 때문
- 버퍼 풀에 데이터 페이지가 한번 적재되면 압축이 해제된 상태로만 데이터 페이지를 관리, MySQL 서버 내부에서는 압축 여부와 관계 없이 투명하게 작동
- 데이터 페이지를 압축한 결과가 용량이 얼마나 될지 예측이 불가능 한데 적어도 하나의 테이블은 동일한 크기의 페이지(블록)으로 통일 되야 하는 문제 발생
    * 운영체제별 특정 버전 파일 시스템에서만 지원되는 펀치홀 기능 사용(16kb페이지가 압축되어 7kb가 될 경우, 9kb공간에 대해 펀치홀을 생성해서 7kb만 남기고 9kb를 운영 체제로 반환)
    * 펀치 홀 기능은 운영체제 뿐만 아니라 하드웨어 자체에서도 해당 기능을 지원해야 사용 가능
    * 파일 시스템 관련 명령어는 펀치홀 기능을 지원하지 못함
    * 이러한 문제로 실제 페이지 압축 기능은 많이 사용되진 않음

- 페이지 압축을 이용하기 위해 테이블을 생성하거나 변경할 때 ```COMPRESSION``` 옵션을 설정 해야함

## 테이블 압축
- 운영체제나 하드웨어에 대한 제약이 없이 사용되어 일반적으로 더 활용도가 높음
- 데이터 파일 크기를 줄일 수 있어 유용하지만, 버퍼 풀 공간 활용률이 낮고, 쿼리 처리 성능이 낮고, 빈번한 데이터 변경시 압축률이 떨어지는 문제

### 압축 테이블 생성
- 테이블 압축을 위해서는 압축을 사용하려는 테이블이 별도의 테이블 스페이스를 활용 해야함
    * innodb_file_per_table 옵션 ON 상태에서 ```ROE_FORMAT=COMPRESSED```옵션 명시

- KEY_BLOCK_SIZE 옵션을 통해 압축된 페이지의 타깃 크기를 명시
    * 2n (n은 2이상)으로만 설정 가능
    * 페이지 크기가 16kb라면 4kb, 8kb까지만 설정 가능(원본 페이지가 16kb이고, 압축된 페이지 크기를 8kb로 설정 => 압축된 결과가 8kb 이하라면 디스크에 저장, 초과라면 원본 페이지를 스플릿 해서 2개의 페이지에 8kb씩 저장)
    * 페이지 크기가 32kb, 64kb면 테이블 압축 적용 불가

- 테이블 압축에서는 InnoDB I/O 레이어가 아무 역할을 하지 않음
- 원본 데이터 페이지의 압축 결과가 목표 크기보다 같거나 작을때까지 페이지를 스플릿 하므로 목표 크기 설정이 중요

### KEY_BLOCK_SIZE 결정
- 테이블을 압축을 적용하기 전 먼저 KEY_BLOCK_SIZE를 4kb 또는 8kb로 테이블을 생성해서 샘플 데이터를 저장해보고 적절한지 판단하는것이 좋음
- 샘플 데이터가 많을수록 좋으니, 최소한 테이블의 데이터 페이지가 10개 정도는 생성되도록 테스트 데이터를 INSERT 해볼것
- 테스트 실행 전에 innodb_cmp_per_index_enabled 시스템 변수를 ON 시켜서 인덱스별로 압축 실행 횟수와 성공 횟수를 기록
- 일반적으로 압축 실패율(압축 결과가 KEY_BLOCK_SIZE를 넘겨 데이터 페이지를 스플릿해서 다시 압축)이 3~5% 미만으로 유지 하는게 좋음
- 압축 실패율이 높다고 해서 압축을 사용하지 말아야 한다는것은 아님. 그 반대의 경우도 있음

### 압축된 페이지의 버퍼 풀 적재 및 사용
- InnoDB 스토리지 엔진은 압축된 테이블의 데이터 페이지를 버퍼 풀에 적재하면 압축된 상태와 압축이 해제된 상태 2개 버전을 관리
- InnoDB 스토리지 엔진은 디스크에서 읽은 상태 그대로의 데이터 페이지 목록을 관리하는 LRU 리스트와, 압축된 페이지들의 압축 해제 버전인 Unzip_LRU 리스트를 별도 관리
- LRU리스트는 압축지 적용되지 않은 테이블의 데이터 페이지와 압축이 적용된 테이블의 압축된 데이터 페이지 2개를 모두 가질 수 있음
- Unzip_LRU 리스트는 압축이 적용된 테이블에서 읽은 데이터 페이지만 관리
- InnoDB 스토리지 엔진은 압축된 테이블에 대해서 버퍼 풀의 공간을 이중으로 사용함으로써 메모리가 낭비
- 압축된 페이지에서 데이터를 읽거나 변경하기 위해서는 압축을 해제해야 하는데, 압축 및 압축 해제 작업은 CPU를 상대적으로 많이 소모하는 작업
- 단점들을 보완하기 위해 Unzip_LRU 별도로 관리
    * 버퍼 풀에 공간이 필요한 경우 LRU리스트에서 원본 데이터 페이지(압축된 형태)는 유지, Unzip_LRU 리스트에서 압축 해제된 버전은 제거
    * 압축된 데이터 페이지가 자주 사용되는 경우 Unzip_LRU리스트에 압축 해제된 페이지를 계속 유지하면서 압축 및 압축 해제 작업 최소화
    * 압축된 데이터 페이지가 사용되지 않아 LRU리스트에서 제거되는 경우 Unzip_LRU 리스트에서 같이 제거

### 테이블 압축 관련 설정
- innodb_com_per_index_enabled: 테이블 압축이 사용된 테이블의 모든 인덱스별로 압축 성공 및 압축 실행 횟수 수집
- innodb_compression_level: 압축률 설정
- innodb_compression_failure_threshold_pct, innodb_compression_pad_pct_max: 압축 실패율이 innodb_compression_failure_threshold_pct 보다 커지면 압축 실행 전 원본 데이터 페이지 끝에 일정 크기의 빈공간 추가, 이 빈공간(패딩)은 innodb_compression_pad_pct_max 을 넘을 수 없음
- innodb_log_compressed_pages: 서버가 비정상적으로 종료되었다가 다시 시작하는 경우, 압축 알고리즘의 버전 차이가 있더라도 복구가 실패하지 않도록 리두로그에 기록